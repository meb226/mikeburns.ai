<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lobby Match – Find Your Advocate</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --red: #DC143C;
      --navy: #0039A6;
      --black: #000000;
      --gray-dark: #333333;
      --gray-mid: #666666;
      --gray-light: #f5f5f5;
      --white: #fff;
      
      --subway-red: #EE352E;
      --subway-blue: #0039A6;
      --subway-turquoise: #00A1DE;
      --subway-orange: #F7931E;
      --subway-green: #00933C;
      
      --card-red-bg: rgba(238, 53, 46, 0.08);
      --card-blue-bg: rgba(0, 57, 166, 0.08);
      --card-turquoise-bg: rgba(0, 161, 222, 0.08);
      --card-orange-bg: rgba(247, 147, 30, 0.08);
      --card-green-bg: rgba(0, 147, 60, 0.08);
      
      --card-red-border: #EE352E;
      --card-blue-border: #0039A6;
      --card-turquoise-border: #00A1DE;
      --card-orange-border: #F7931E;
      --card-green-border: #00933C;
      
      --highlight-color: #0039A6;
      --vignelli-gray: #4A4A4A;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      color: var(--black);
      background: var(--white);
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 48px 32px;
    }

    header {
      margin-bottom: 48px;
      border-bottom: 2px solid var(--black);
      padding-bottom: 24px;
    }

    h1 {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
    }

    .tagline {
      font-size: 18px;
      color: var(--gray-mid);
    }

    .intro {
      margin-top: 16px;
      font-size: 15px;
      color: var(--gray-dark);
      line-height: 1.6;
    }

    .intro strong {
      color: var(--navy);
      font-weight: 600;
    }

    .intro-callout {
      margin-top: 12px;
    }

    .intro-callout strong {
      color: var(--black);
    }

    .progress-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
    }

    .progress-step {
      flex: 1;
      height: 4px;
      background: var(--gray-light);
      transition: background 0.3s;
    }

    .progress-step.active { background: var(--navy); }
    .progress-step.complete { background: var(--red); }

    .step { display: none; }
    .step.active { display: block; }

    .step-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .step-subtitle {
      font-size: 14px;
      color: var(--gray-mid);
      margin-bottom: 24px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    select, textarea, input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-family: inherit;
      border: 1px solid var(--gray-mid);
      background: var(--white);
      margin-bottom: 24px;
    }

    select:focus, textarea:focus, input:focus {
      outline: none;
      border-color: var(--navy);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .issue-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .issue-col { flex: 1; }
    .issue-col select, .issue-col input { margin-bottom: 0; }

    .issue-col-with-remove {
      display: flex;
      gap: 8px;
    }

    .issue-col-with-remove input { flex: 1; }

    .btn-add-issue {
      background: transparent;
      border: 1px dashed var(--gray-mid);
      color: var(--gray-mid);
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 24px;
    }

    .btn-add-issue:hover {
      border-color: var(--navy);
      color: var(--navy);
    }

    .additional-issue-row { margin-bottom: 12px; }

    .btn-remove-issue {
      background: transparent;
      border: 1px solid var(--gray-mid);
      color: var(--gray-mid);
      padding: 12px 14px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      flex-shrink: 0;
    }

    .btn-remove-issue:hover {
      border-color: var(--red);
      color: var(--red);
    }

    .radio-group { margin-bottom: 24px; }

    .radio-option {
      display: flex;
      align-items: flex-start;
      padding: 12px;
      border: 1px solid var(--gray-light);
      margin-bottom: 8px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .radio-option:hover { border-color: var(--navy); }

    .radio-option.selected {
      border-color: var(--navy);
      background: rgba(0, 57, 166, 0.03);
    }

    .radio-option input {
      margin-right: 12px;
      margin-top: 2px;
    }

    .radio-label { font-weight: 500; }

    .radio-desc {
      font-size: 13px;
      color: var(--gray-mid);
      margin-top: 2px;
    }

    .btn-row {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--gray-light);
    }

    button {
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-back {
      background: transparent;
      border: 1px solid var(--gray-mid);
      color: var(--gray-dark);
    }

    .btn-back:hover {
      border-color: var(--black);
      color: var(--black);
    }

    .btn-next {
      background: var(--navy);
      border: none;
      color: var(--white);
    }

    .btn-next:hover { background: #002d80; }

    .btn-generate {
      background: var(--red);
      border: none;
      color: var(--white);
      padding: 14px 32px;
      font-size: 15px;
    }

    .btn-generate:hover { background: #b01030; }
    .btn-generate:disabled { background: var(--gray-mid); cursor: not-allowed; }

    .scenario-bar {
      background: var(--gray-light);
      padding: 16px;
      margin-bottom: 32px;
    }

    .scenario-bar label {
      display: inline;
      margin-right: 12px;
    }

    .scenario-bar select {
      width: auto;
      margin-bottom: 0;
      padding: 8px 12px;
    }

    #results { display: none; }
    #results.visible { display: block; }

    .analysis-section {
      margin-bottom: 32px;
      padding: 24px;
      background: #F5F5F5;
      border: 2px solid var(--vignelli-gray);
    }

    .analysis-header {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--vignelli-gray);
      margin-bottom: 16px;
    }

    .analysis-content {
      font-size: 16px;
      line-height: 1.7;
    }

    .analysis-content p { margin: 0 0 12px 0; }
    .analysis-content p:last-child { margin-bottom: 0; }

    .analysis-highlight {
      font-weight: 600;
      color: var(--navy);
    }

    .matches-header { margin-bottom: 24px; }

    .matches-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--black);
      margin: 0;
    }

    .carousel-container {
      position: relative;
      margin-bottom: 32px;
      width: 100%;
      overflow: hidden;
    }

    .match-cards.carousel {
      display: flex;
      flex-wrap: nowrap;
      transition: transform 0.3s ease;
    }

    .match-card {
      border: 3px solid;
      padding: 24px;
      box-sizing: border-box;
      overflow: hidden;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
    }

    .match-card:nth-child(1) { background: var(--card-red-bg); border-color: var(--card-red-border); }
    .match-card:nth-child(2) { background: var(--card-blue-bg); border-color: var(--card-blue-border); }
    .match-card:nth-child(3) { background: var(--card-turquoise-bg); border-color: var(--card-turquoise-border); }
    .match-card:nth-child(4) { background: var(--card-orange-bg); border-color: var(--card-orange-border); }
    .match-card:nth-child(5) { background: var(--card-green-bg); border-color: var(--card-green-border); }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card-rank-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: var(--white);
      flex-shrink: 0;
    }

    .match-card:nth-child(1) .card-rank-circle { background: var(--card-red-border); }
    .match-card:nth-child(2) .card-rank-circle { background: var(--card-blue-border); }
    .match-card:nth-child(3) .card-rank-circle { background: var(--card-turquoise-border); }
    .match-card:nth-child(4) .card-rank-circle { background: var(--card-orange-border); }
    .match-card:nth-child(5) .card-rank-circle { background: var(--card-green-border); }

    .card-firm-name {
      font-size: 20px;
      font-weight: 700;
      color: var(--black);
      margin: 0;
    }

    .card-overall-score { text-align: right; }

    .overall-score-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-mid);
      margin-bottom: 2px;
    }

    .overall-score-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--black);
      line-height: 1;
    }

    .overall-score-max {
      font-size: 14px;
      font-weight: 400;
      color: var(--gray-mid);
    }

    .card-rationale {
      font-size: 15px;
      line-height: 1.65;
      color: var(--gray-dark);
      margin-bottom: 20px;
    }

    .card-rationale p { margin: 0 0 12px 0; }
    .card-rationale p:last-child { margin-bottom: 0; }

    .card-rationale strong {
      color: var(--highlight-color);
      font-weight: 600;
    }

    .card-section { margin-bottom: 16px; }

    .card-section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-mid);
      margin-bottom: 8px;
    }

    .personnel-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .personnel-box {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.1);
      padding: 10px 12px;
      flex: 1;
      min-width: 200px;
      max-width: calc(50% - 5px);
    }

    .personnel-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--black);
      margin-bottom: 2px;
    }

    .personnel-background {
      font-size: 12px;
      color: var(--gray-mid);
      line-height: 1.4;
    }

    .clients-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      list-style: none;
    }

    .clients-list li {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.1);
      padding: 4px 10px;
      font-size: 13px;
      color: var(--gray-dark);
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .subjects-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .subjects-list li {
      font-size: 13px;
      color: var(--gray-dark);
      padding-left: 16px;
      position: relative;
    }

    .subjects-list li:before {
      content: "→";
      position: absolute;
      left: 0;
      color: var(--gray-mid);
    }

    .committee-engagement {
      background: rgba(0, 57, 166, 0.05);
      padding: 12px;
      border-left: 3px solid var(--navy);
    }

    .committee-text {
      font-size: 14px;
      color: var(--gray-dark);
      margin: 0;
      line-height: 1.5;
    }

    .card-list { list-style: none; }

    .card-list li {
      font-size: 14px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      color: var(--gray-dark);
    }

    .card-list li:last-child { border-bottom: none; }

    .card-list.strengths li:before {
      content: "✓ ";
      color: var(--subway-green);
      font-weight: bold;
    }

    .card-list.considerations li:before {
      content: "◦ ";
      color: var(--gray-mid);
    }

    .score-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .score-item { text-align: center; }

    .score-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-mid);
      margin-bottom: 4px;
    }

    .score-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--black);
    }

    .score-value .max {
      font-size: 12px;
      font-weight: 400;
      color: var(--gray-mid);
    }

    .firm-link {
      display: inline-block;
      margin-top: 16px;
      font-size: 14px;
      color: var(--navy);
      text-decoration: none;
      font-weight: 500;
    }

    .firm-link:hover { text-decoration: underline; }

    .export-bar {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .btn-export {
      background: var(--gray-light);
      border: 1px solid var(--gray-mid);
      color: var(--gray-dark);
      padding: 10px 20px;
      font-size: 13px;
    }

    .btn-export:hover {
      background: var(--white);
      border-color: var(--navy);
      color: var(--navy);
    }

    .new-search-row { margin-top: 16px; }

    .btn-new-search {
      background: var(--navy);
      border: none;
      color: var(--white);
      padding: 12px 24px;
    }

    .btn-new-search:hover { background: #002d80; }

    .carousel-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 16px;
    }

    .carousel-btn {
      background: var(--white);
      border: 1px solid var(--gray-mid);
      width: 36px;
      height: 36px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .carousel-btn:hover {
      background: var(--navy);
      color: var(--white);
    }

    .carousel-dots {
      display: flex;
      gap: 8px;
    }

    .carousel-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--gray-light);
      border: 1px solid var(--gray-mid);
      cursor: pointer;
      transition: all 0.2s;
    }

    .carousel-dot.active { background: var(--navy); border-color: var(--navy); }
    .carousel-dot:nth-child(1).active { background: var(--card-red-border); border-color: var(--card-red-border); }
    .carousel-dot:nth-child(2).active { background: var(--card-blue-border); border-color: var(--card-blue-border); }
    .carousel-dot:nth-child(3).active { background: var(--card-turquoise-border); border-color: var(--card-turquoise-border); }
    .carousel-dot:nth-child(4).active { background: var(--card-orange-border); border-color: var(--card-orange-border); }
    .carousel-dot:nth-child(5).active { background: var(--card-green-border); border-color: var(--card-green-border); }

    /* Loading State */
    .loading { padding: 32px 0; }

    .loading-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
      font-size: 15px;
      color: var(--gray-dark);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--subway-red);
    }

    .status-dot.streaming {
      animation: pulse-red 1s ease-in-out infinite;
    }

    .status-dot.complete {
      background: var(--subway-green);
      animation: none;
    }

    @keyframes pulse-red {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Preview Cards - show immediately with scores */
    .preview-cards {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .preview-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border: 2px solid;
      background: var(--white);
    }

    .preview-card:nth-child(1) { border-color: var(--card-red-border); }
    .preview-card:nth-child(2) { border-color: var(--card-blue-border); }
    .preview-card:nth-child(3) { border-color: var(--card-turquoise-border); }
    .preview-card:nth-child(4) { border-color: var(--card-orange-border); }
    .preview-card:nth-child(5) { border-color: var(--card-green-border); }

    .preview-card-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .preview-rank {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: var(--white);
    }

    .preview-card:nth-child(1) .preview-rank { background: var(--card-red-border); }
    .preview-card:nth-child(2) .preview-rank { background: var(--card-blue-border); }
    .preview-card:nth-child(3) .preview-rank { background: var(--card-turquoise-border); }
    .preview-card:nth-child(4) .preview-rank { background: var(--card-orange-border); }
    .preview-card:nth-child(5) .preview-rank { background: var(--card-green-border); }

    .preview-firm-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--black);
    }

    .preview-score {
      font-size: 24px;
      font-weight: 700;
      color: var(--black);
    }

    .preview-score span {
      font-size: 12px;
      font-weight: 400;
      color: var(--gray-mid);
    }

    /* Live Analysis Panel */
    .live-analysis-panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      overflow: hidden;
    }

    .live-analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: #252525;
      border-bottom: 1px solid #333;
      cursor: pointer;
    }

    .live-analysis-header:hover { background: #2a2a2a; }

    .live-analysis-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .live-analysis-toggle {
      font-size: 10px;
      color: #666;
      transition: transform 0.2s;
    }

    .live-analysis-toggle.collapsed { transform: rotate(-90deg); }

    .live-analysis-content {
      max-height: 200px;
      overflow-y: auto;
      padding: 12px 16px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 11px;
      line-height: 1.5;
      color: #00ff00;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .live-analysis-content.collapsed { display: none; }

    .live-cursor {
      display: inline-block;
      width: 7px;
      height: 12px;
      background: #00ff00;
      animation: blink 0.8s step-end infinite;
      vertical-align: middle;
      margin-left: 1px;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .disclaimer {
      font-size: 12px;
      color: var(--gray-mid);
      margin-top: 32px;
      padding: 16px;
      background: var(--gray-light);
    }

    .methodology-section {
      margin-top: 24px;
      border: 1px solid var(--gray-light);
    }

    .methodology-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--gray-light);
      cursor: pointer;
      user-select: none;
    }

    .methodology-toggle:hover { background: #e8e8e8; }

    .methodology-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-dark);
    }

    .methodology-arrow {
      font-size: 10px;
      color: var(--gray-mid);
      transition: transform 0.2s;
    }

    .methodology-arrow.open { transform: rotate(180deg); }

    .methodology-content {
      padding: 16px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--gray-dark);
      border-top: 1px solid var(--gray-light);
    }

    .methodology-content p { margin: 0; }

    @media (max-width: 600px) {
      .container { padding: 24px 16px; }
      h1 { font-size: 24px; }
      .btn-row { flex-direction: column; gap: 12px; }
      .btn-back, .btn-next, .btn-generate { width: 100%; }
      .issue-row { flex-direction: column; }
      .personnel-box { max-width: 100%; min-width: 100%; }
      .match-card { padding: 16px; }
      .card-header { flex-direction: column; gap: 12px; }
      .card-overall-score { text-align: left; }
      .clients-list li { max-width: 100%; }
    }

    .footer-copyright {
      text-align: center;
      font-size: 12px;
      color: var(--gray-mid);
      padding: 24px;
      margin-top: 48px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Lobby Match</h1>
      <p class="tagline">Find the right advocate for your cause.</p>
      <p class="intro">Washington runs on relationships and expertise — but finding the right lobbying firm shouldn't require being a Beltway insider yourself. Lobby Match analyzes thousands of Lobbying Disclosure Act filings to match you with firms that have <strong>proven track records</strong> in your policy area, <strong>relevant government experience</strong>, and <strong>clients like you</strong>. No more guesswork, cold calls, or relying on who-knows-who.</p>
      <p class="intro intro-callout"><strong>Answer a few questions, and we'll show you who's actually been in the arena on issues that matter to you.</strong></p>
    </header>

    <div class="scenario-bar">
      <label for="scenario-select">Try an example:</label>
      <select id="scenario-select">
        <option value="">— Select a scenario —</option>
      </select>
    </div>

    <div class="progress-bar">
      <div class="progress-step active" data-step="1"></div>
      <div class="progress-step" data-step="2"></div>
      <div class="progress-step" data-step="3"></div>
      <div class="progress-step" data-step="4"></div>
    </div>

    <form id="matchForm">
      <div class="step active" data-step="1">
        <h2 class="step-title">What type of organization are you?</h2>
        <p class="step-subtitle">This helps us understand your resources and typical advocacy needs.</p>
        
        <div class="radio-group" id="orgType">
          <label class="radio-option">
            <input type="radio" name="organizationType" value="individual">
            <div>
              <div class="radio-label">Individual</div>
              <div class="radio-desc">High-net-worth individual with personal advocacy goals</div>
            </div>
          </label>
          <label class="radio-option">
            <input type="radio" name="organizationType" value="nonprofit">
            <div>
              <div class="radio-label">Nonprofit Organization</div>
              <div class="radio-desc">501(c)(3), 501(c)(4), trade association, or similar</div>
            </div>
          </label>
          <label class="radio-option">
            <input type="radio" name="organizationType" value="small-business">
            <div>
              <div class="radio-label">Small Business</div>
              <div class="radio-desc">Under $50M annual revenue, limited DC experience</div>
            </div>
          </label>
          <label class="radio-option">
            <input type="radio" name="organizationType" value="mid-market">
            <div>
              <div class="radio-label">Mid-Market Company</div>
              <div class="radio-desc">$50M-$500M revenue, some policy exposure</div>
            </div>
          </label>
          <label class="radio-option">
            <input type="radio" name="organizationType" value="large-company">
            <div>
              <div class="radio-label">Large Company</div>
              <div class="radio-desc">$500M+ revenue, established government affairs function</div>
            </div>
          </label>
        </div>

        <div class="btn-row">
          <button type="button" class="btn-next" onclick="nextStep()">Continue</button>
        </div>
      </div>

      <div class="step" data-step="2">
        <h2 class="step-title">What policy areas are you focused on?</h2>
        <p class="step-subtitle">Select your primary issue and add any related areas.</p>
        
        <div class="issue-row">
          <div class="issue-col">
            <label for="issueArea">Primary Issue</label>
            <select id="issueArea" name="issueArea" required>
              <option value="">— Select an issue —</option>
            </select>
          </div>
          <div class="issue-col">
            <label for="priorities">Key priorities</label>
            <input type="text" id="priorities" name="priorities" placeholder="e.g., Tax credits, regulatory relief">
          </div>
        </div>

        <div id="additionalIssues"></div>
        <button type="button" class="btn-add-issue" onclick="addIssueRow()">+ Add another issue area</button>

        <div class="btn-row">
          <button type="button" class="btn-back" onclick="prevStep()">Back</button>
          <button type="button" class="btn-next" onclick="nextStep()">Continue</button>
        </div>
      </div>

      <div class="step" data-step="3">
        <h2 class="step-title">What's your advocacy budget?</h2>
        <p class="step-subtitle">This helps match you with appropriately-sized firms.</p>
        
        <div class="radio-group" id="budgetGroup">
          <label class="radio-option">
            <input type="radio" name="budget" value="$2,500-$5,000/month">
            <div>
              <div class="radio-label">$2,500 – $5,000/month</div>
              <div class="radio-desc">Entry-level engagement, focused scope</div>
            </div>
          </label>
          <label class="radio-option">
            <input type="radio" name="budget" value="$5,000-$15,000/month">
            <div>
              <div class="radio-label">$5,000 – $15,000/month</div>
              <div class="radio-desc">Standard boutique firm retainer</div>
            </div>
          </label>
          <label class="radio-option">
            <input type="radio" name="budget" value="$15,000-$30,000/month">
            <div>
              <div class="radio-label">$15,000 – $30,000/month</div>
              <div class="radio-desc">Full-service representation</div>
            </div>
          </label>
          <label class="radio-option">
            <input type="radio" name="budget" value="$30,000+/month">
            <div>
              <div class="radio-label">$30,000+/month</div>
              <div class="radio-desc">Major firm, comprehensive campaign</div>
            </div>
          </label>
          <label class="radio-option">
            <input type="radio" name="budget" value="Not specified">
            <div>
              <div class="radio-label">Prefer not to say</div>
              <div class="radio-desc">Match based on other factors</div>
            </div>
          </label>
        </div>

        <div class="btn-row">
          <button type="button" class="btn-back" onclick="prevStep()">Back</button>
          <button type="button" class="btn-next" onclick="nextStep()">Continue</button>
        </div>
      </div>

      <div class="step" data-step="4">
        <h2 class="step-title">Tell us a bit more</h2>
        <p class="step-subtitle">These details help us find the best fit for your situation.</p>
        
        <label for="orgDescription">Describe your organization in 1-2 sentences</label>
        <textarea id="orgDescription" name="orgDescription" required placeholder="e.g., We're a 501(c)(3) patient advocacy group focused on rare disease research funding..."></textarea>

        <label for="policyGoals">What specific policy outcome are you trying to achieve?</label>
        <textarea id="policyGoals" name="policyGoals" placeholder="e.g., We want to secure an earmark in the next appropriations bill..."></textarea>

        <label for="timeline">What's your timeline and any relevant context?</label>
        <textarea id="timeline" name="timeline" placeholder="e.g., The bill is expected to move in Q2..."></textarea>

        <div class="btn-row">
          <button type="button" class="btn-back" onclick="prevStep()">Back</button>
          <button type="submit" class="btn-generate" id="generateBtn">Generate Matches</button>
        </div>
      </div>
    </form>

    <div id="results">
      <div id="analysisSection" class="analysis-section">
        <div class="analysis-header">Executive Summary</div>
        <div id="analysisContent" class="analysis-content"></div>
      </div>
      
      <div class="matches-header"><h2>Top Matches</h2></div>
      
      <div class="carousel-container">
        <div id="matchCards" class="match-cards carousel"></div>
        <div class="carousel-nav">
          <button class="carousel-btn carousel-prev" onclick="prevCard()">←</button>
          <div class="carousel-dots" id="carouselDots"></div>
          <button class="carousel-btn carousel-next" onclick="nextCard()">→</button>
        </div>
      </div>

      <div id="resultsContent" class="results-content" style="display: none;"></div>

      <div class="export-bar">
        <button class="btn-export" onclick="copyResults()">Copy to Clipboard</button>
        <button class="btn-export" onclick="downloadPDF()">Download PDF</button>
        <button class="btn-export" onclick="emailResults()">E-Mail</button>
      </div>
      <div class="new-search-row">
        <button class="btn-new-search" onclick="startOver()">New Search</button>
      </div>

      <div class="disclaimer">
        <strong>Disclaimer:</strong> This analysis is based on public LDA filings and is for informational purposes only. It does not constitute legal, business, or professional advice. Past performance does not guarantee future results. Users should conduct their own due diligence before engaging any firm.
      </div>
      
      <div id="methodologySection" class="methodology-section">
        <div class="methodology-toggle" onclick="toggleMethodology()">
          <span class="methodology-title">Methodology</span>
          <span class="methodology-arrow">▼</span>
        </div>
        <div id="methodologyContent" class="methodology-content" style="display: none;"></div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" style="display: none;">
      <div class="loading">
        <div class="loading-status">
          <div class="status-dot streaming" id="statusDot"></div>
          <span id="loadingText">Finding your top matches...</span>
        </div>

        <!-- Preview cards - populated immediately with scores -->
        <div class="preview-cards" id="previewCards"></div>

        <!-- Live Analysis Panel -->
        <div class="live-analysis-panel">
          <div class="live-analysis-header" onclick="toggleLiveAnalysis()">
            <div class="live-analysis-title">
              <span>Live Analysis</span>
            </div>
            <span class="live-analysis-toggle" id="liveAnalysisToggle">▼</span>
          </div>
          <div class="live-analysis-content" id="liveAnalysisContent"><span class="live-cursor"></span></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer-copyright">© Mike Burns 2025</footer>

  <script>
    let currentStep = 1;
    const totalSteps = 4;
    let scenarios = [];
    let issueCodes = [];
    let liveAnalysisCollapsed = false;

    function toggleLiveAnalysis() {
      const content = document.getElementById('liveAnalysisContent');
      const toggle = document.getElementById('liveAnalysisToggle');
      liveAnalysisCollapsed = !liveAnalysisCollapsed;
      content.classList.toggle('collapsed', liveAnalysisCollapsed);
      toggle.classList.toggle('collapsed', liveAnalysisCollapsed);
    }

    function updateLiveAnalysis(text) {
      const content = document.getElementById('liveAnalysisContent');
      content.innerHTML = text + '<span class="live-cursor"></span>';
      content.scrollTop = content.scrollHeight;
    }

    function setStreamingComplete() {
      const dot = document.getElementById('statusDot');
      dot.classList.remove('streaming');
      dot.classList.add('complete');
      document.getElementById('loadingText').textContent = 'Analysis complete!';
      const content = document.getElementById('liveAnalysisContent');
      content.innerHTML = content.innerHTML.replace(/<span class="live-cursor"><\/span>/g, '');
    }

    function showPreviewCards(firms) {
      const container = document.getElementById('previewCards');
      container.innerHTML = firms.map((f, i) => `
        <div class="preview-card">
          <div class="preview-card-left">
            <div class="preview-rank">${i + 1}</div>
            <div class="preview-firm-name">${f.name}</div>
          </div>
          <div class="preview-score">${f.scores.overallMatch}<span>/100</span></div>
        </div>
      `).join('');
      document.getElementById('loadingText').textContent = 'Generating detailed analysis...';
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadIssueCodes();
      await loadScenarios();
      setupRadioListeners();
    });

    async function loadIssueCodes() {
      try {
        const res = await fetch('/api/lobbymatch-issues');
        issueCodes = await res.json();
        const select = document.getElementById('issueArea');
        issueCodes.forEach(issue => {
          const option = document.createElement('option');
          option.value = issue.value;
          option.textContent = issue.label;
          select.appendChild(option);
        });
      } catch (err) { console.error('Failed to load issue codes:', err); }
    }

    async function loadScenarios() {
      try {
        const res = await fetch('/api/lobbymatch-scenarios');
        scenarios = await res.json();
        const select = document.getElementById('scenario-select');
        scenarios.forEach((scenario, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = scenario.name;
          select.appendChild(option);
        });
        select.addEventListener('change', (e) => {
          if (e.target.value !== '') loadScenario(parseInt(e.target.value));
        });
      } catch (err) { console.error('Failed to load scenarios:', err); }
    }

    function loadScenario(index) {
      const scenario = scenarios[index];
      if (!scenario) return;
      
      // Populate fields but stay on step 1
      document.querySelectorAll('input[name="organizationType"]').forEach(radio => {
        radio.checked = radio.value === scenario.organizationType;
        if (radio.checked) radio.closest('.radio-option').classList.add('selected');
        else radio.closest('.radio-option').classList.remove('selected');
      });
      document.getElementById('issueArea').value = scenario.issueArea;
      document.getElementById('priorities').value = scenario.priorities || '';
      document.querySelectorAll('input[name="budget"]').forEach(radio => {
        radio.checked = radio.value === scenario.budget;
        if (radio.checked) radio.closest('.radio-option').classList.add('selected');
        else radio.closest('.radio-option').classList.remove('selected');
      });
      document.getElementById('orgDescription').value = scenario.orgDescription;
      document.getElementById('policyGoals').value = scenario.policyGoals || '';
      document.getElementById('timeline').value = scenario.timeline || '';
      // Don't skip to step 4 - let user click through
    }

    function setupRadioListeners() {
      document.querySelectorAll('.radio-option').forEach(option => {
        option.addEventListener('click', () => {
          const group = option.closest('.radio-group');
          group.querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          option.querySelector('input[type="radio"]').checked = true;
        });
      });
    }

    let issueRowCount = 0;

    function addIssueRow() {
      issueRowCount++;
      const container = document.getElementById('additionalIssues');
      const row = document.createElement('div');
      row.className = 'issue-row additional-issue-row';
      row.id = `issueRow${issueRowCount}`;
      const options = issueCodes.map(issue => `<option value="${issue.value}">${issue.label}</option>`).join('');
      row.innerHTML = `
        <div class="issue-col">
          <label>Additional Issue</label>
          <div class="issue-col-with-remove">
            <select name="additionalIssue"><option value="">— Select an issue —</option>${options}</select>
            <button type="button" class="btn-remove-issue" onclick="removeIssueRow(${issueRowCount})">×</button>
          </div>
        </div>
      `;
      container.appendChild(row);
    }

    function removeIssueRow(id) {
      const row = document.getElementById(`issueRow${id}`);
      if (row) row.remove();
    }

    function nextStep() { if (currentStep < totalSteps) goToStep(currentStep + 1); }
    function prevStep() { if (currentStep > 1) goToStep(currentStep - 1); }

    function goToStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
      document.querySelectorAll('.progress-step').forEach(p => {
        const pStep = parseInt(p.dataset.step);
        p.classList.remove('active', 'complete');
        if (pStep < step) p.classList.add('complete');
        else if (pStep === step) p.classList.add('active');
      });
      currentStep = step;
    }

    document.getElementById('matchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const additionalIssueSelects = document.querySelectorAll('#additionalIssues select');
      const additionalIssues = Array.from(additionalIssueSelects).map(s => s.value).filter(v => v);
      const formData = {
        organizationType: document.querySelector('input[name="organizationType"]:checked')?.value,
        issueArea: document.getElementById('issueArea').value,
        additionalIssues,
        budget: document.querySelector('input[name="budget"]:checked')?.value,
        priorities: document.getElementById('priorities').value,
        orgDescription: document.getElementById('orgDescription').value,
        policyGoals: document.getElementById('policyGoals')?.value || '',
        timeline: document.getElementById('timeline')?.value || ''
      };
      
      if (!formData.organizationType || !formData.issueArea || !formData.orgDescription) {
        alert('Please complete all required fields.');
        return;
      }
      
      // Reset state
      document.getElementById('statusDot').classList.remove('complete');
      document.getElementById('statusDot').classList.add('streaming');
      document.getElementById('loadingText').textContent = 'Finding your top matches...';
      document.getElementById('liveAnalysisContent').innerHTML = '<span class="live-cursor"></span>';
      document.getElementById('previewCards').innerHTML = '';
      liveAnalysisCollapsed = false;
      document.getElementById('liveAnalysisContent').classList.remove('collapsed');
      document.getElementById('liveAnalysisToggle').classList.remove('collapsed');
      
      document.getElementById('matchForm').style.display = 'none';
      document.querySelector('.progress-bar').style.display = 'none';
      document.querySelector('.scenario-bar').style.display = 'none';
      document.getElementById('loading').style.display = 'block';
      
      let streamedText = '';
      let preComputedScores = null;
      
      try {
        const response = await fetch('/api/lobbymatch-match', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\n');
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                
                if (data.type === 'preview') {
                  preComputedScores = data.topFirms;
                  showPreviewCards(data.topFirms);
                } else if (data.type === 'chunk') {
                  streamedText += data.text;
                  updateLiveAnalysis(streamedText);
                } else if (data.type === 'complete') {
                  setStreamingComplete();
                  await new Promise(resolve => setTimeout(resolve, 400));
                  displayResults(data.analysis, preComputedScores);
                } else if (data.type === 'error') {
                  throw new Error(data.error);
                }
              } catch (parseErr) { /* skip malformed */ }
            }
          }
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error generating matches: ' + error.message);
        startOver();
      }
    });

    function displayResults(analysis, preComputedScores) {
      document.getElementById('loading').style.display = 'none';
      
      if (analysis.raw) {
        document.getElementById('resultsContent').style.display = 'block';
        document.getElementById('analysisSection').style.display = 'none';
        document.querySelector('.carousel-container').style.display = 'none';
        let formatted = analysis.raw
          .replace(/### (.*)/g, '<h3>$1</h3>')
          .replace(/\*\*#(\d+): (.*?)\*\*/g, '<h4>#$1: $2</h4>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/^- (.*)/gm, '• $1');
        document.getElementById('resultsContent').innerHTML = formatted;
      } else {
        document.getElementById('resultsContent').style.display = 'none';
        document.getElementById('analysisSection').style.display = 'block';
        document.querySelector('.carousel-container').style.display = 'block';
        
        if (analysis.executiveSummary) {
          let summaryHtml = analysis.executiveSummary.replace(/\*\*(.*?)\*\*/g, '<span class="analysis-highlight">$1</span>');
          const sentences = summaryHtml.match(/[^.!?]+[.!?]+/g) || [summaryHtml];
          if (sentences.length > 2) {
            const mid = Math.ceil(sentences.length / 2);
            summaryHtml = `<p>${sentences.slice(0, mid).join(' ')}</p><p>${sentences.slice(mid).join(' ')}</p>`;
          } else {
            summaryHtml = `<p>${summaryHtml}</p>`;
          }
          document.getElementById('analysisContent').innerHTML = summaryHtml;
        }
        
        const cardsContainer = document.getElementById('matchCards');
        cardsContainer.innerHTML = '';
        if (analysis.matches && analysis.matches.length > 0) {
          analysis.matches.forEach((match, index) => {
            const card = createMatchCard(match, index);
            cardsContainer.appendChild(card);
          });
          requestAnimationFrame(() => { requestAnimationFrame(() => { initCarousel(analysis.matches.length); }); });
        }
        
        if (analysis.methodology) {
          document.getElementById('methodologyContent').innerHTML = `<p>${analysis.methodology}</p>`;
          document.getElementById('methodologySection').style.display = 'block';
        } else {
          document.getElementById('methodologySection').style.display = 'none';
        }
      }
      document.getElementById('results').classList.add('visible');
    }

    function toggleMethodology() {
      const content = document.getElementById('methodologyContent');
      const arrow = document.querySelector('.methodology-arrow');
      if (content.style.display === 'none') { content.style.display = 'block'; arrow.classList.add('open'); }
      else { content.style.display = 'none'; arrow.classList.remove('open'); }
    }

    let currentCard = 0;
    let totalCards = 0;

    function initCarousel(count) {
      totalCards = count;
      currentCard = 0;
      const container = document.querySelector('.carousel-container');
      const cardsContainer = document.getElementById('matchCards');
      const cards = document.querySelectorAll('.match-card');
      if (container && cardsContainer && cards.length > 0) {
        let containerWidth = container.offsetWidth;
        if (containerWidth <= 0) containerWidth = container.parentElement?.offsetWidth || 720;
        cards.forEach(card => {
          card.style.width = containerWidth + 'px';
          card.style.minWidth = containerWidth + 'px';
          card.style.maxWidth = containerWidth + 'px';
          card.style.flexShrink = '0';
        });
        cardsContainer.style.width = (containerWidth * count) + 'px';
      }
      const dotsContainer = document.getElementById('carouselDots');
      dotsContainer.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const dot = document.createElement('div');
        dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
        dot.onclick = () => goToCard(i);
        dotsContainer.appendChild(dot);
      }
      updateCarousel();
    }

    function updateCarousel() {
      const container = document.querySelector('.carousel-container');
      const cardsContainer = document.getElementById('matchCards');
      if (container && cardsContainer) {
        let containerWidth = container.offsetWidth;
        if (containerWidth <= 0) containerWidth = container.parentElement?.offsetWidth || 720;
        cardsContainer.style.transform = `translateX(-${currentCard * containerWidth}px)`;
      }
      const dots = document.querySelectorAll('.carousel-dot');
      dots.forEach((dot, i) => { dot.classList.toggle('active', i === currentCard); });
    }

    function nextCard() { currentCard = (currentCard + 1) % totalCards; updateCarousel(); }
    function prevCard() { currentCard = (currentCard - 1 + totalCards) % totalCards; updateCarousel(); }
    function goToCard(index) { currentCard = index; updateCarousel(); }

    window.addEventListener('resize', function() {
      if (totalCards > 0) {
        const container = document.querySelector('.carousel-container');
        const cardsContainer = document.getElementById('matchCards');
        const cards = document.querySelectorAll('.match-card');
        if (container && cardsContainer && cards.length > 0) {
          let containerWidth = container.offsetWidth;
          if (containerWidth <= 0) containerWidth = container.parentElement?.offsetWidth || 720;
          cards.forEach(card => {
            card.style.width = containerWidth + 'px';
            card.style.minWidth = containerWidth + 'px';
            card.style.maxWidth = containerWidth + 'px';
          });
          cardsContainer.style.width = (containerWidth * totalCards) + 'px';
          cardsContainer.style.transform = `translateX(-${currentCard * containerWidth}px)`;
        }
      }
    });

    function emailResults() {
      const subject = encodeURIComponent('Lobby Match Results');
      const body = encodeURIComponent(buildResultsText());
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }

    function buildResultsText() {
      let text = 'LOBBY MATCH RESULTS\n\n';
      const analysis = document.getElementById('analysisContent').textContent;
      if (analysis) text += 'EXECUTIVE SUMMARY\n' + analysis + '\n\n';
      const cards = document.querySelectorAll('.match-card');
      cards.forEach((card, i) => {
        const firmName = card.querySelector('.card-firm-name')?.textContent || '';
        const overallScore = card.querySelector('.overall-score-value')?.textContent || '';
        const rationale = card.querySelector('.card-rationale')?.textContent?.trim() || '';
        text += `MATCH #${i + 1}: ${firmName}\nOverall Score: ${overallScore}\n\n${rationale}\n\n---\n\n`;
      });
      return text;
    }

    function createMatchCard(match, index) {
      const card = document.createElement('div');
      card.className = 'match-card';
      let rationaleHtml = '';
      if (match.rationale) {
        let processedRationale = match.rationale.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        const paragraphs = processedRationale.split('\n\n').filter(p => p.trim());
        if (paragraphs.length === 1) {
          const sentences = processedRationale.match(/[^.!?]+[.!?]+/g) || [processedRationale];
          const midpoint = Math.ceil(sentences.length / 2);
          const para1 = sentences.slice(0, midpoint).join(' ');
          const para2 = sentences.slice(midpoint).join(' ');
          rationaleHtml = `<p>${para1}</p>${para2 ? `<p>${para2}</p>` : ''}`;
        } else {
          rationaleHtml = paragraphs.map(p => `<p>${p}</p>`).join('');
        }
      }
      const scores = match.scores || {};
      let personnelHtml = '';
      if (match.keyPersonnel && match.keyPersonnel.length > 0) {
        personnelHtml = `<div class="card-section"><div class="card-section-title">Key Personnel</div><div class="personnel-list">${match.keyPersonnel.map(p => `<div class="personnel-box"><div class="personnel-name">${p.name}</div><div class="personnel-background">${p.background || ''}</div></div>`).join('')}</div></div>`;
      }
      let clientsHtml = '';
      if (match.representativeClients && match.representativeClients.length > 0) {
        clientsHtml = `<div class="card-section"><div class="card-section-title">Representative Clients</div><ul class="clients-list">${match.representativeClients.map(c => `<li>${c}</li>`).join('')}</ul></div>`;
      }
      let subjectsHtml = '';
      if (match.subjectsLobbied && match.subjectsLobbied.length > 0) {
        subjectsHtml = `<div class="card-section"><div class="card-section-title">Subjects Lobbied</div><ul class="subjects-list">${match.subjectsLobbied.map(s => `<li>${s}</li>`).join('')}</ul></div>`;
      }
      let firmLinkHtml = '';
      if (match.firmWebsite) {
        firmLinkHtml = `<a href="${match.firmWebsite}" target="_blank" rel="noopener noreferrer" class="firm-link">Visit ${match.firmName} →</a>`;
      }
      const keyStrengths = match.keyStrengths || [];
      card.innerHTML = `
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-rank-circle">${match.rank || index + 1}</div>
            <h3 class="card-firm-name">${match.firmName || 'Unknown Firm'}</h3>
          </div>
          <div class="card-overall-score">
            <div class="overall-score-label">Overall Match</div>
            <div class="overall-score-value">${scores.overallMatch || '—'}<span class="overall-score-max">/100</span></div>
          </div>
        </div>
        <div class="card-rationale">${rationaleHtml}</div>
        ${personnelHtml}
        ${clientsHtml}
        ${subjectsHtml}
        <div class="card-section">
          <div class="card-section-title">Key Strengths</div>
          <ul class="card-list strengths">${keyStrengths.map(s => `<li>${s}</li>`).join('')}</ul>
        </div>
        <div class="card-section">
          <div class="card-section-title">Considerations</div>
          <ul class="card-list considerations">${(match.considerations || []).map(c => `<li>${c}</li>`).join('')}</ul>
        </div>
        <div class="score-grid">
          <div class="score-item"><div class="score-label">Issue Alignment</div><div class="score-value">${scores.issueAlignment || '—'}<span class="max">/100</span></div></div>
          <div class="score-item"><div class="score-label">Experience</div><div class="score-value">${scores.experienceDepth || '—'}<span class="max">/100</span></div></div>
          <div class="score-item"><div class="score-label">Cost Fit</div><div class="score-value">${scores.costFit || '—'}<span class="max">/100</span></div></div>
        </div>
        ${firmLinkHtml}
      `;
      return card;
    }

    function copyResults() {
      const text = buildResultsText();
      navigator.clipboard.writeText(text).then(() => { alert('Copied to clipboard!'); });
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 20;
      const maxWidth = pageWidth - (margin * 2);
      let y = 20;
      function addText(text, fontSize, isBold, color) {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', isBold ? 'bold' : 'normal');
        if (color) doc.setTextColor(color[0], color[1], color[2]);
        else doc.setTextColor(0, 0, 0);
        const lines = doc.splitTextToSize(text, maxWidth);
        lines.forEach(line => {
          if (y > 270) { doc.addPage(); y = 20; }
          doc.text(line, margin, y);
          y += fontSize * 0.5;
        });
        y += 4;
      }
      doc.setTextColor(0, 57, 166);
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('Lobby Match Results', margin, y);
      y += 10;
      doc.setTextColor(100, 100, 100);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('Generated: ' + new Date().toLocaleDateString(), margin, y);
      y += 8;
      const analysis = document.getElementById('analysisContent').textContent;
      if (analysis) {
        addText('Executive Summary', 14, true, [74, 74, 74]);
        addText(analysis, 11, false);
        y += 3;
      }
      doc.setDrawColor(200, 200, 200);
      doc.line(margin, y, pageWidth - margin, y);
      y += 8;
      const cards = document.querySelectorAll('.match-card');
      cards.forEach((card, i) => {
        if (y > 220) { doc.addPage(); y = 20; }
        const firmName = card.querySelector('.card-firm-name')?.textContent || '';
        const overallScore = card.querySelector('.overall-score-value')?.textContent || '';
        const rationale = card.querySelector('.card-rationale')?.textContent?.trim() || '';
        const colors = [[238, 53, 46], [0, 57, 166], [0, 161, 222], [247, 147, 30], [0, 147, 60]];
        const cardColor = colors[i] || colors[0];
        doc.setFillColor(cardColor[0], cardColor[1], cardColor[2]);
        doc.rect(margin, y - 6, 10, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(String(i + 1), margin + 3, y + 2);
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text(firmName, margin + 14, y + 1);
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Score: ' + overallScore, pageWidth - margin - 25, y + 1);
        y += 12;
        addText(rationale.replace(/\s+/g, ' '), 10, false);
        y += 10;
        if (i < cards.length - 1) {
          doc.setDrawColor(220, 220, 220);
          doc.line(margin, y, pageWidth - margin, y);
          y += 10;
        }
      });
      doc.save('Lobby-Match-Results.pdf');
    }

    function startOver() {
      document.getElementById('results').classList.remove('visible');
      const matchCards = document.getElementById('matchCards');
      matchCards.innerHTML = '';
      matchCards.style.transform = 'translateX(0)';
      matchCards.style.width = '';
      document.getElementById('analysisContent').innerHTML = '';
      document.getElementById('carouselDots').innerHTML = '';
      document.getElementById('resultsContent').innerHTML = '';
      document.getElementById('additionalIssues').innerHTML = '';
      document.getElementById('methodologyContent').innerHTML = '';
      document.getElementById('methodologyContent').style.display = 'none';
      document.querySelector('.methodology-arrow').classList.remove('open');
      document.getElementById('loading').style.display = 'none';
      document.getElementById('previewCards').innerHTML = '';
      issueRowCount = 0;
      currentCard = 0;
      totalCards = 0;
      document.getElementById('matchForm').style.display = 'block';
      document.querySelector('.progress-bar').style.display = 'flex';
      document.querySelector('.scenario-bar').style.display = 'block';
      document.getElementById('matchForm').reset();
      document.querySelectorAll('.radio-option.selected').forEach(o => o.classList.remove('selected'));
      document.getElementById('scenario-select').value = '';
      goToStep(1);
    }
  </script>
</body>
</html>
